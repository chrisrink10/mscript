/*------------------------------------------------------------------------------
 *    Copyright 2016 Chris Rink
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 *----------------------------------------------------------------------------*/

#include "codegen.h"
#include "../src/bytecode.h"
#include "../src/parser.h"
#include "../src/vm.h"

typedef struct {
    const char *val;         /** Value of the input token */
    ms_VMByteCode *bc;       /** Generated bytecode structure */
} CodeGenResultTuple;

/*
 * TEST DEFINITIONS
 */

MunitTest codegen_tests[] = {
    {
        "/Literals",
        prs_TestCodeGenLiterals,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ArrayLiterals",
        prs_TestCodeGenArrayLiterals,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/UnaryExpressions",
        prs_TestCodeGenUnaryExprs,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/BinaryExpressions",
        prs_TestCodeGenBinaryExprs,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ConditionalExpressions",
        prs_TestCodeGenConditionalExprs,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/OperatorPrecedence",
        prs_TestCodeGenExprPrecedence,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/FunctionCalls",
        prs_TestCodeGenFunctionCalls,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/QualifiedIdents",
        prs_TestCodeGenQualifiedIdents,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/GlobalReferences",
        prs_TestCodeGenGlobalReferences,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/BreakAndContinueStatements",
        prs_TestCodeGenBreakAndContinueStatements,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/DeleteStatement",
        prs_TestCodeGenDeleteStatement,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ForIncrStatements",
        prs_TestCodeGenForIncStatements,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ForIterStatements",
        prs_TestCodeGenForIterStatements,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ForExprStatements",
        prs_TestCodeGenForExprStatements,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/IfStatement",
        prs_TestCodeGenIfStatements,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ImportStatement",
        prs_TestCodeGenImportStatement,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/MergeStatement",
        prs_TestCodeGenMergeStatement,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/ReturnStatement",
        prs_TestCodeGenReturnStatement,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/FuncDeclaration",
        prs_TestCodeGenFuncDeclaration,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/Declaration",
        prs_TestCodeGenDeclaration,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/Assignment",
        prs_TestCodeGenAssignment,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    {
        "/CompoundAssignment",
        prs_TestCodeGenCompoundAssignment,
        NULL,
        NULL,
        MUNIT_TEST_OPTION_NONE,
        NULL
    },
    { NULL, NULL, NULL, NULL, MUNIT_TEST_OPTION_NONE, NULL }
};

/*
 * FORWARD DECLARATIONS
 */

static MunitResult CompareByteCode(const ms_VMByteCode *bc1, const ms_VMByteCode *bc2);
static MunitResult CompareFunctionValues(const ms_VMFunc *fn1, const ms_VMFunc *fn2);
static MunitResult CompareValues(const ms_VMValue *val1, const ms_VMValue *val2);
static MunitResult TestCodeGenResultTuple(CodeGenResultTuple *tuples, size_t len);
static void CleanByteCode(ms_VMByteCode *bc);
static void CleanValue(ms_VMValue *v);

/*
 * AST UTILITY MACROS
 */

#define VM_IDENT(v)                 (dsbuf_new_l(v, sizeof(v)-1))
#define VM_OPC(opc, arg)            ms_VMOpCodeWithArg(opc, arg)
#define VM_FLOAT(v)                 ((ms_VMValue){ .type = VMVAL_FLOAT, .val = (ms_VMData){ .f = v } })
#define VM_INT(v)                   ((ms_VMValue){ .type = VMVAL_INT,   .val = (ms_VMData){ .i = v } })
#define VM_STR(v)                   ((ms_VMValue){ .type = VMVAL_STR,   .val = (ms_VMData){ .s = dsbuf_new_l(v, sizeof(v)-1) } })
#define VM_BOOL(v)                  ((ms_VMValue){ .type = VMVAL_BOOL,  .val = (ms_VMData){ .b = v } })
#define VM_NULL()                   ((ms_VMValue){ .type = VMVAL_NULL,  .val = (ms_VMData){ .n = MS_VM_NULL_POINTER } })
#define VM_FUNC(f)                  ((ms_VMValue){ .type = VMVAL_FUNC,  .val = (ms_VMData){ .fn = f } })
#define VM_FUNC_ARGLIST(l, ...)     (dsarray_new_lit((void **)(((DSBuffer*[]){ __VA_ARGS__ , })), l, l, NULL, (dsarray_free_fn)dsbuf_destroy))
#define VM_EMPTY_ARGLIST()          (dsarray_new_cap(1, NULL, NULL))

/*
 * TEST CASE FUNCTIONS
 */

MunitResult prs_TestCodeGenLiterals(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "0;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(0),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "3;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(3),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "0.0;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(0.0),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "3.14;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(3.14),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "false;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
        {
            .val = "null;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                },
                .nops = 1, .nvals = 1,
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenArrayLiterals(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "[];",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_MAKE_LIST, 0),
                },
                .idents = NULL,
                .nops = 1, .nvals = 0, .nidents = 0
            }
        },
        {
            .val = "[1];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_MAKE_LIST, 1),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "[1,];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_MAKE_LIST, 1),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "[1 + 3];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                    VM_INT(3),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_MAKE_LIST, 1),
                },
                .idents = NULL,
                .nops = 4, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "[1 + 3,];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                    VM_INT(3),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_MAKE_LIST, 1),
                },
                .idents = NULL,
                .nops = 4, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "[1 + 3, \"shifty\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                    VM_INT(3),
                    VM_STR("shifty"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_MAKE_LIST, 2),
                },
                .idents = NULL,
                .nops = 5, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "[1 + 3, \"shifty\",];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                    VM_INT(3),
                    VM_STR("shifty"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_MAKE_LIST, 2),
                },
                .idents = NULL,
                .nops = 5, .nvals = 3, .nidents = 0
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenUnaryExprs(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "-3;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(3)
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_NEGATE, 0),
                },
                .nops = 2, .nvals = 1,
            }
        },
        {
            .val = "--2.72;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(2.72),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_NEGATE, 0),
                },
                .nops = 3, .nvals = 1,
            }
        },
        {
            .val = "!true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_NOT, 0),
                },
                .nops = 2, .nvals = 1,
            }
        },
        {
            .val = "!!false;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_NOT, 0),
                    VM_OPC(OPC_NOT, 0),
                },
                .nops = 3, .nvals = 1,
            }
        },
        {
            .val = "~792;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(792),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                },
                .nops = 2, .nvals = 1,
            }
        },
        {
            .val = "~~42;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(42),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                },
                .nops = 3, .nvals = 1,
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenBinaryExprs(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "7 + 3.6;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "3 + ~3;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(3),
                    VM_INT(3),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 4, .nvals = 2,
            }
        },
        {
            .val = "16 - false;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(16),
                    VM_BOOL(false),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SUBTRACT, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "3 - -3;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(3),
                    VM_INT(3),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_SUBTRACT, 0),
                },
                .nops = 4, .nvals = 2,
            }
        },
        {
            .val = "2 * 3.14;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(2),
                    VM_FLOAT(3.14),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_MULTIPLY, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "17 / 8.25;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(17),
                    VM_FLOAT(8.25),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DIVIDE, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "8.888 \\ 6;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(8.888),
                    VM_INT(6),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_IDIVIDE, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "42 % 8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(42),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_MODULO, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "5.25 ** 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(5.25),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "5 << 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(5),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SHIFT_LEFT, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "183822 >> 4;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(183822),
                    VM_INT(4),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SHIFT_RIGHT, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "13 & 97;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(13),
                    VM_INT(97),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_AND, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "3 | 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(3),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_OR, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "53 ^ 7;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(53),
                    VM_INT(7),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_XOR, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "46.12 <= 73;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(46.12),
                    VM_INT(73),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_LE, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "true < 14;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                    VM_INT(14),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_LT, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "33 != 1988;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(33),
                    VM_INT(1988),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_NOT_EQ, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "71 == 0.33;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(71),
                    VM_FLOAT(0.33),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EQ, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "81.3 > 90;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(81.3),
                    VM_INT(90),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GT, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "1000 >= 10000;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1000),
                    VM_INT(10000),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GE, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },

        {
            .val = "true && false;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                    VM_BOOL(false),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_AND, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
        {
            .val = "true && !true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_NOT, 0),
                    VM_OPC(OPC_AND, 0),
                },
                .nops = 4, .nvals = 2,
            }
        },
        {
            .val = "1 || null;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(1),
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_OR, 0),
                },
                .nops = 3, .nvals = 2,
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenConditionalExprs(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "(use_degrees) ? 360 : 2.0 * pi;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(360),
                    VM_FLOAT(2.0),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 4),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GOTO, 7),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_MULTIPLY, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("use_degrees"),
                    VM_IDENT("pi"),
                }),
                .nops = 7, .nvals = 2, .nidents = 2
            }
        },
        {
            .val = "select(has_value: value);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 4),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_GOTO, 5),
                    VM_OPC(OPC_PUSH, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("has_value"),
                    VM_IDENT("value"),
                }),
                .nops = 5, .nvals = 1, .nidents = 2
            }
        },
        {
            .val = "select(has_value: value, 10);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 4),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_GOTO, 5),
                    VM_OPC(OPC_PUSH, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("has_value"),
                    VM_IDENT("value"),
                }),
                .nops = 5, .nvals = 1, .nidents = 2
            }
        },
        {
            .val = "select(i >= 10: 10, i >= 5: 5, 0);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                    VM_INT(10),
                    VM_INT(5),
                    VM_INT(5),
                    VM_INT(0),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 6),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GOTO, 13),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 12),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_GOTO, 13),
                    VM_OPC(OPC_PUSH, 4),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("i"),
                }),
                .nops = 13, .nvals = 5, .nidents = 1
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenExprPrecedence(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "false || false && true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                    VM_BOOL(false),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_AND, 0),
                    VM_OPC(OPC_OR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(false || false) && true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                    VM_BOOL(false),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_OR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_AND, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(false || !false) && true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                    VM_BOOL(false),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_NOT, 0),
                    VM_OPC(OPC_OR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_AND, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "false == false != true;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                    VM_BOOL(false),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NOT_EQ, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "false == (false != true);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(false),
                    VM_BOOL(false),
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NOT_EQ, 0),
                    VM_OPC(OPC_EQ, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 > 3.6 < 8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GT, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_LT, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 > (3.6 < 8);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_LT, 0),
                    VM_OPC(OPC_GT, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 > 3.6 >= 8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GT, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GE, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 | 2 & 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_AND, 0),
                    VM_OPC(OPC_BITWISE_OR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ^ 2 & 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_AND, 0),
                    VM_OPC(OPC_BITWISE_XOR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ^ 2 | 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_XOR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_OR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ^ (2 | 15);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_BITWISE_XOR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(7 | 2) & 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_AND, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(7 | 2) & ~15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                    VM_OPC(OPC_BITWISE_AND, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "~(7 | 2) & 15;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(2),
                    VM_INT(15),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_BITWISE_NOT, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_BITWISE_AND, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "15 | 1 << 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(15),
                    VM_INT(1),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SHIFT_LEFT, 0),
                    VM_OPC(OPC_BITWISE_OR, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(15 | 1) << 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(15),
                    VM_INT(1),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SHIFT_LEFT, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 + 3.6 - 8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SUBTRACT, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 + (3.6 - 8);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SUBTRACT, 0),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 + (3.6 - -8);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_SUBTRACT, 0),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "(7 + 3.6) - -8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_SUBTRACT, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "7 + 3.6 * -8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_MULTIPLY, 0),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "7 / 3.6 * -8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DIVIDE, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_MULTIPLY, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "7 \\ 3.6 % -8;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_FLOAT(3.6),
                    VM_INT(8),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_IDIVIDE, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_NEGATE, 0),
                    VM_OPC(OPC_MODULO, 0),
                },
                .nops = 6, .nvals = 3,
            }
        },
        {
            .val = "7 ** 4 ** 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(4),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "(7 ** 4) ** 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(4),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ** 4 * 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(4),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_MULTIPLY, 0),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ** 4 + 2;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(4),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_ADD, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
        {
            .val = "7 ** (4 + 2);",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(7),
                    VM_INT(4),
                    VM_INT(2),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_EXPONENTIATE, 0),
                },
                .nops = 5, .nvals = 3,
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenFunctionCalls(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "$len();",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL_BUILTIN, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("$len"),
                }),
                .nops = 2, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "foo();",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("foo"),
                }),
                .nops = 2, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "$len(\"string\");",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("string"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL_BUILTIN, 1),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("$len"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "foo(\"string\");",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("string"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL, 1),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("foo"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "foo()();",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL, 0),
                    VM_OPC(OPC_CALL, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("foo"),
                }),
                .nops = 3, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "bar(\"baz\")();",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("baz"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_CALL, 1),
                    VM_OPC(OPC_CALL, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("bar"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenQualifiedIdents(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "name;",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 1, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "name.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name?.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 8),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GOTO, 10),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 10, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "name[\"first\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name?[\"first\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 8),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GOTO, 10),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 10, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "name.first.second.third;",
            .bc = &(ms_VMByteCode) {
                .values = (ms_VMValue[]) {
                    VM_STR("first"),
                    VM_STR("second"),
                    VM_STR("third"),
                },
                .code = (ms_VMOpCode[]) {
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer *[]) {
                    VM_IDENT("name"),
                }),
                .nops = 7, .nvals = 3, .nidents = 1
            },
        },
        {
            .val = "name.first?.second?.third;",
            .bc = &(ms_VMByteCode) {
                .values = (ms_VMValue[]) {
                    VM_STR("first"),
                    VM_NULL(),
                    VM_STR("second"),
                    VM_NULL(),
                    VM_STR("third"),
                },
                .code = (ms_VMOpCode[]) {
                    VM_OPC(OPC_GET_NAME, 0),

                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),

                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 10),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GOTO, 12),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GET_ATTR, 0),

                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 19),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_GOTO, 21),
                    VM_OPC(OPC_PUSH, 4),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer *[]) {
                    VM_IDENT("name"),
                }),
                .nops = 21, .nvals = 5, .nidents = 1
            },
        },
        {
            .val = "name?[\"first\", \"second\"]?.third;",
            .bc = &(ms_VMByteCode) {
                .values = (ms_VMValue[]) {
                    VM_NULL(),
                    VM_STR("first"),
                    VM_NULL(),
                    VM_STR("second"),
                    VM_NULL(),
                    VM_STR("third"),
                },
                .code = (ms_VMOpCode[]) {
                    VM_OPC(OPC_GET_NAME, 0),

                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 8),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GOTO, 10),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),

                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 17),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GOTO, 19),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_GET_ATTR, 0),

                    VM_OPC(OPC_DUP, 0),
                    VM_OPC(OPC_PUSH, 4),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 26),
                    VM_OPC(OPC_POP, 0),
                    VM_OPC(OPC_PUSH, 4),
                    VM_OPC(OPC_GOTO, 28),
                    VM_OPC(OPC_PUSH, 5),
                    VM_OPC(OPC_GET_ATTR, 0),
                },
                .idents = ((DSBuffer *[]) {
                    VM_IDENT("name"),
                }),
                .nops = 28, .nvals = 6, .nidents = 1
            },
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenGlobalReferences(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "@glo;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_GLO, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "@glo.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_GLO, 1),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "@glo.first.second;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GET_GLO, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "@glo.first.second[\"third\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                    VM_STR("second"),
                    VM_STR("third"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_GET_GLO, 3),
                },
                .idents = NULL,
                .nops = 5, .nvals = 4, .nidents = 0
            }
        },
        {
            .val = "@glo[\"first\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_GLO, 1),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "@glo[\"first\", \"second\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GET_GLO, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "@glo[\"first\", \"second\"].third;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                    VM_STR("first"),
                    VM_STR("second"),
                    VM_STR("third"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_GET_GLO, 3),
                },
                .idents = NULL,
                .nops = 5, .nvals = 4, .nidents = 0
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenBreakAndContinueStatements(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "for true { break; }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 5),
                    VM_OPC(OPC_GOTO, 5),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = NULL,
                .nops = 6, .nvals = 1, .nidents = 0
            },
        },
        {
            .val = "for true { continue; }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 5),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = NULL,
                .nops = 6, .nvals = 1, .nidents = 0
            },
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenDeleteStatement(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "del name;",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_DEL_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 1, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "del name.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_DEL_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "del name[\"first\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_DEL_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "del name.first.second;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DEL_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 5, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "del name[\"first\", \"second\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DEL_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 5, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "del name[\"first\"].second;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DEL_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 5, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "del @name;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_DEL_GLO, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "del @name.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DEL_GLO, 1),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "del @name[\"first\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_DEL_GLO, 1),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "del @name.first.second;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_DEL_GLO, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "del @name[\"first\", \"second\"];",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_DEL_GLO, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "del @name[\"first\"].second;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@name"),
                    VM_STR("first"),
                    VM_STR("second"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_DEL_GLO, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenForIncStatements(const MunitParameter params[], void *user_data) {
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenForIterStatements(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "for var i in range { }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_NEW_NAME, 1),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_NEXT, 0),
                    VM_OPC(OPC_SET_NAME, 1),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 10),
                    VM_OPC(OPC_GOTO, 2),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("range"),
                    VM_IDENT("i"),
                },
                .nops = 11, .nvals = 1, .nidents = 2
            },
        },
        {
            .val = "for i in range { }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_NEXT, 0),
                    VM_OPC(OPC_SET_NAME, 1),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 9),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("range"),
                    VM_IDENT("i"),
                },
                .nops = 10, .nvals = 1, .nidents = 2
            },
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenForExprStatements(const MunitParameter params[], void *user_data)  {
    CodeGenResultTuple exprs[] = {
        {
            .val = "for true { }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_BOOL(true),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 4),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = NULL,
                .nops = 5, .nvals = 1, .nidents = 0
            },
        },
        {
            .val = "for cond { }",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 4),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("cond"),
                },
                .nops = 5, .nvals = 0, .nidents = 1
            },
        },
        {
            .val = "for cond || fn() { }",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_CALL, 0),
                    VM_OPC(OPC_OR, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 7),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("cond"),
                    VM_IDENT("fn")
                },
                .nops = 8, .nvals = 0, .nidents = 2
            },
        },
        {
            .val = "for arr.drained() { }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("drained"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_CALL, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 7),
                    VM_OPC(OPC_GOTO, 1),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("arr"),
                },
                .nops = 8, .nvals = 1, .nidents = 1
            },
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenIfStatements(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "if cost >= money { }",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 6),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("cost"),
                    VM_IDENT("money"),
                },
                .nops = 6, .nvals = 0, .nidents = 2
            },
        },
        {
            .val = "if cost >= money { \n"
                "    // do nothing\n"
                "} else { \n"
                "    // also do nothing\n"
                "}",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 7),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 9),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("cost"),
                    VM_IDENT("money"),
                },
                .nops = 9, .nvals = 0, .nidents = 2
            },
        },
        {
            .val = "if cost >= money { \n"
                "    // freak out\n"
                "} else if cost == money { \n"
                "    // sigh a breath of relief\n"
                "} else { \n"
                "    // all good\n"
                "}",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 7),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 16),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_GET_NAME, 1),
                    VM_OPC(OPC_EQ, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 14),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 16),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("cost"),
                    VM_IDENT("money"),
                },
                .nops = 16, .nvals = 0, .nidents = 2
            },
        },
        {
            .val = "if pct >= 0.9 {\n"
                "    return \"A\";\n"
                "} else if pct >= 0.8 { \n"
                "    return \"B\";\n"
                "} else if pct >= 0.7 { \n"
                "    return \"C\";\n"
                "} else {\n"
                "    return \"F\";\n"
                "}",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FLOAT(0.9),
                    VM_STR("A"),
                    VM_FLOAT(0.8),
                    VM_STR("B"),
                    VM_FLOAT(0.7),
                    VM_STR("C"),
                    VM_STR("F"),
                },
                .code = (ms_VMOpCode[]){
                    /* pct >= 0.9 */
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 9),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_RETURN, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 31),

                    /* pct >= 0.8 */
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 18),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_RETURN, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 31),

                    /* pct >= 0.7 */
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 4),
                    VM_OPC(OPC_GE, 0),
                    VM_OPC(OPC_JUMP_IF_FALSE, 27),
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 5),
                    VM_OPC(OPC_RETURN, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                    VM_OPC(OPC_GOTO, 31),

                    /* else */
                    VM_OPC(OPC_PUSH_BLOCK, 0),
                    VM_OPC(OPC_PUSH, 6),
                    VM_OPC(OPC_RETURN, 0),
                    VM_OPC(OPC_POP_BLOCK, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("pct"),
                },
                .nops = 31, .nvals = 7, .nidents = 1
            },
        },
    };
    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenImportStatement(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "import Http;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http")
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_IMPORT, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "import Http.Server;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http"),
                    VM_STR("Server"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_IMPORT, 1),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "import Http.Server.Errors;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http"),
                    VM_STR("Server"),
                    VM_STR("Errors"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_IMPORT, 2),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "import Http : httplib;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http")
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_IMPORT, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("httplib"),
                },
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "import Http.Server : srv;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http"),
                    VM_STR("Server"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_IMPORT, 1),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("srv")
                },
                .nops = 4, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "import Http.Server.Errors : errs;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Http"),
                    VM_STR("Server"),
                    VM_STR("Errors"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_IMPORT, 2),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("errs")
                },
                .nops = 5, .nvals = 3, .nidents = 1
            }
        },
    };
    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenMergeStatement(const MunitParameter params[], void *user_data) {
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenReturnStatement(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "return;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "return null;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_NULL(),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "return \"Selena\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Selena"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = NULL,
                .nops = 2, .nvals = 1, .nidents = 0
            }
        },
        {
            .val = "return name;",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("name"),
                },
                .nops = 2, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "return name.first;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("name"),
                },
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "return @glo;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("@glo"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_GLO, 0),
                    VM_OPC(OPC_RETURN, 0),
                },
                .idents = NULL,
                .nops = 3, .nvals = 1, .nidents = 0
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenFuncDeclaration(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "func MakeName(first, last) { return first + last; }",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FUNC(&((ms_VMFunc) {
                        .args = VM_FUNC_ARGLIST(2, VM_IDENT("first"), VM_IDENT("last")),
                        .code = &(ms_VMByteCode){
                            .values = NULL,
                            .code = (ms_VMOpCode[]) {
                                VM_OPC(OPC_GET_NAME, 0),
                                VM_OPC(OPC_GET_NAME, 1),
                                VM_OPC(OPC_ADD, 0),
                                VM_OPC(OPC_RETURN, 0),
                            },
                            .idents = (DSBuffer *[]) {
                                VM_IDENT("first"),
                                VM_IDENT("last"),
                            },
                            .nops = 4, .nvals = 0, .nidents = 2
                        }
                    })),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("MakeName"),
                },
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "var MakeName := func(first, last) { return first + last; };",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_FUNC(&((ms_VMFunc) {
                        .args = VM_FUNC_ARGLIST(2, VM_IDENT("first"), VM_IDENT("last")),
                        .code = &(ms_VMByteCode) {
                            .values = NULL,
                            .code = (ms_VMOpCode[]) {
                                VM_OPC(OPC_GET_NAME, 0),
                                VM_OPC(OPC_GET_NAME, 1),
                                VM_OPC(OPC_ADD, 0),
                                VM_OPC(OPC_RETURN, 0),
                            },
                            .idents = (DSBuffer *[]) {
                                VM_IDENT("first"),
                                VM_IDENT("last"),
                            },
                            .nops = 4, .nvals = 0, .nidents = 2
                        }
                    })),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("MakeName"),
                },
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenDeclaration(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "var name;",
            .bc = &(ms_VMByteCode){
                .values = NULL,
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("name"),
                },
                .nops = 1, .nvals = 0, .nidents = 1
            }
        },
        {
            .val = "var name := \"Calvin\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Calvin"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("name"),
                },
                .nops = 3, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "var name := \"Calvin\", age;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Calvin"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                    VM_OPC(OPC_NEW_NAME, 1),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("name"),
                    VM_IDENT("age"),
                },
                .nops = 4, .nvals = 1, .nidents = 2
            }
        },
        {
            .val = "var age, name := \"Calvin\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Calvin"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_NEW_NAME, 1),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 1),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("age"),
                    VM_IDENT("name"),
                },
                .nops = 4, .nvals = 1, .nidents = 2
            }
        },
        {
            .val = "var age, name := \"Calvin\", address;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Calvin"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_NEW_NAME, 0),
                    VM_OPC(OPC_NEW_NAME, 1),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 1),
                    VM_OPC(OPC_NEW_NAME, 2),
                },
                .idents = (DSBuffer*[]){
                    VM_IDENT("age"),
                    VM_IDENT("name"),
                    VM_IDENT("address"),
                },
                .nops = 5, .nvals = 1, .nidents = 3
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenAssignment(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "name := \"Daenerys Stormborn\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Daenerys Stormborn"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 2, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name.first := \"Daenerys\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Daenerys"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "name[\"first\"] := \"Daenerys\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Daenerys"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 2, .nidents = 1
            }
        },
        {
            .val = "data[\"address\"].city := \"London\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("London"),
                    VM_STR("address"),
                    VM_STR("city"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("data"),
                }),
                .nops = 6, .nvals = 3, .nidents = 1
            }
        },
        {
            .val = "data[\"address\", \"city\"] := \"London\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("London"),
                    VM_STR("address"),
                    VM_STR("city"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_GET_ATTR, 0),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SET_ATTR, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("data"),
                }),
                .nops = 6, .nvals = 3, .nidents = 1
            }
        },
        {
            .val = "@name := \"Daenerys Stormborn\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Daenerys Stormborn"),
                    VM_STR("@name"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_SET_GLO, 0),
                },
                .idents = NULL,
                .nops = 3, .nvals = 2, .nidents = 0
            }
        },
        {
            .val = "@name.first := \"Daenerys\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Daenerys"),
                    VM_STR("@name"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SET_GLO, 1),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "@name[\"first\"] := \"Kurt\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Kurt"),
                    VM_STR("@name"),
                    VM_STR("first"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_SET_GLO, 1),
                },
                .idents = NULL,
                .nops = 4, .nvals = 3, .nidents = 0
            }
        },
        {
            .val = "@data.address.city := \"Rivendell\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("Rivendell"),
                    VM_STR("@data"),
                    VM_STR("address"),
                    VM_STR("city"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_SET_GLO, 2),
                },
                .idents = NULL,
                .nops = 5, .nvals = 4, .nidents = 0
            }
        },
        {
            .val = "@data[\"address\", \"city\"] := \"London\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("London"),
                    VM_STR("@data"),
                    VM_STR("address"),
                    VM_STR("city"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_SET_GLO, 2),
                },
                .idents = NULL,
                .nops = 5, .nvals = 4, .nidents = 0
            }
        },
        {
            .val = "@data[\"address\"].city := \"London\";",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_STR("London"),
                    VM_STR("@data"),
                    VM_STR("address"),
                    VM_STR("city"),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_PUSH, 1),
                    VM_OPC(OPC_PUSH, 2),
                    VM_OPC(OPC_PUSH, 3),
                    VM_OPC(OPC_SET_GLO, 2),
                },
                .idents = NULL,
                .nops = 5, .nvals = 4, .nidents = 0
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

MunitResult prs_TestCodeGenCompoundAssignment(const MunitParameter params[], void *user_data) {
    CodeGenResultTuple exprs[] = {
        {
            .val = "name += 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_ADD, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name -= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SUBTRACT, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name *= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_MULTIPLY, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name /= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_DIVIDE, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name \\= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_IDIVIDE, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name %= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_MODULO, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name &= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_BITWISE_AND, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name |= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_BITWISE_OR, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name ^= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_BITWISE_XOR, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name <<= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SHIFT_LEFT, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
        {
            .val = "name >>= 10;",
            .bc = &(ms_VMByteCode){
                .values = (ms_VMValue[]){
                    VM_INT(10),
                },
                .code = (ms_VMOpCode[]){
                    VM_OPC(OPC_GET_NAME, 0),
                    VM_OPC(OPC_PUSH, 0),
                    VM_OPC(OPC_SHIFT_RIGHT, 0),
                    VM_OPC(OPC_SET_NAME, 0),
                },
                .idents = ((DSBuffer*[]){
                    VM_IDENT("name"),
                }),
                .nops = 4, .nvals = 1, .nidents = 1
            }
        },
    };

    size_t len = sizeof(exprs) / sizeof(exprs[0]);
    TestCodeGenResultTuple(exprs, len);
    return MUNIT_OK;
}

/*
 * COMPARISON FUNCTIONS
 */

static MunitResult CompareByteCode(const ms_VMByteCode *bc1, const ms_VMByteCode *bc2) {
    munit_assert_non_null(bc1);
    munit_assert_non_null(bc2);
    munit_assert_cmp_int(bc1->nops, ==, bc2->nops);
    munit_assert_cmp_int(bc1->nvals, ==, bc2->nvals);
    munit_assert_cmp_int(bc1->nidents, ==, bc2->nidents);

    for (size_t i = 0; i < bc1->nops; i++) {
        ms_VMOpCode opc1 = bc1->code[i];
        ms_VMOpCode opc2 = bc2->code[i];
        const char *nm1 = ms_VMOpCodeToString(opc1);
        const char *nm2 = ms_VMOpCodeToString(opc2);
        ms_VMOpCodeType type1 = ms_VMOpCodeGetCode(opc1);
        ms_VMOpCodeType type2 = ms_VMOpCodeGetCode(opc2);
        int arg1 = ms_VMOpCodeGetArg(opc1);
        int arg2 = ms_VMOpCodeGetArg(opc2);

        munit_logf(MUNIT_LOG_INFO, "  opc1='%s'", nm1);
        munit_logf(MUNIT_LOG_INFO, "  opc2='%s'", nm2);
        munit_assert_cmp_int(type1, ==, type2);
        munit_assert_cmp_int(arg1, ==, arg2);
        munit_assert_cmp_int(opc1, ==, opc2);
    }

    for (size_t i = 0; i < bc1->nvals; i++) {
        CompareValues(&bc1->values[i], &bc2->values[i]);
    }

    for (size_t i = 0; i < bc1->nidents; i++) {
        const char *s1 = dsbuf_char_ptr(bc1->idents[i]);
        const char *s2 = dsbuf_char_ptr(bc2->idents[i]);
        munit_logf(MUNIT_LOG_INFO, "  ident1='%s'", s1);
        munit_logf(MUNIT_LOG_INFO, "  ident2='%s'", s2);
        munit_assert_string_equal(s1, s2);
    }

    return MUNIT_OK;
}

static MunitResult CompareFunctionValues(const ms_VMFunc *fn1, const ms_VMFunc *fn2) {
    munit_assert_non_null(fn1);
    munit_assert_non_null(fn2);

    size_t nargs1 = dsarray_len(fn1->args);
    size_t nargs2 = dsarray_len(fn2->args);
    munit_assert_cmp_size(nargs1, ==, nargs2);

    for (size_t i = 0; i < nargs1; i++) {
        DSBuffer *arg1 = dsarray_get(fn1->args, i);
        DSBuffer *arg2 = dsarray_get(fn2->args, i);

        munit_assert_non_null(arg1);
        munit_assert_non_null(arg2);

        munit_assert(dsbuf_equals(arg1, arg2));
    }

    CompareByteCode(fn1->code, fn2->code);
    return MUNIT_OK;
}

static MunitResult CompareValues(const ms_VMValue *val1, const ms_VMValue *val2) {
    munit_assert_non_null(val1);
    munit_assert_non_null(val2);

    munit_assert_cmp_int(val1->type, ==, val2->type);
    switch (val1->type) {
        case VMVAL_FLOAT:
            munit_assert_cmp_double(val1->val.f, ==, val2->val.f);
            break;
        case VMVAL_INT:
            munit_assert_cmp_int(val1->val.i, ==, val2->val.i);
            break;
        case VMVAL_STR:
            munit_assert_true(dsbuf_equals(val1->val.s, val2->val.s));
            break;
        case VMVAL_BOOL:
            munit_assert(val1->val.b == val2->val.b);
            break;
        case VMVAL_NULL:
            munit_assert(val1->val.n == val2->val.n);
            break;
        case VMVAL_FUNC:
            CompareFunctionValues(val1->val.fn, val2->val.fn);
            break;
    }

    return MUNIT_OK;
}

static MunitResult TestCodeGenResultTuple(CodeGenResultTuple *tuples, size_t len) {
    ms_Parser *prs = ms_ParserNew();
    munit_assert_non_null(prs);

    for (size_t i = 0; i < len; i++) {
        CodeGenResultTuple *tuple = &tuples[i];
        ms_ParserInitString(prs, tuple->val);
        munit_logf(MUNIT_LOG_INFO, "  code='%s'", tuple->val);

        const ms_AST *ast;
        ms_Error *err;
        ms_Result pres = ms_ParserParse(prs, &ast, &err);
        if (err) {
            munit_logf(MUNIT_LOG_INFO, "err = %s", err->msg);
            ms_ErrorDestroy(err);
        }

        munit_assert_cmp_int(pres, !=, MS_RESULT_ERROR);
        munit_assert_non_null(ast);
        munit_assert_null(err);

        ms_VMByteCode *code;
        ms_Result gres = ms_VMByteCodeGenerateFromAST(ast, &code, &err);
        if (err) {
            munit_logf(MUNIT_LOG_INFO, "err = %s", err->msg);
            ms_ErrorDestroy(err);
        }

        munit_assert_cmp_int(gres, !=, MS_RESULT_ERROR);
        munit_assert_non_null(code);
        munit_assert_null(err);

        CompareByteCode(code, tuple->bc);
        ms_VMByteCodeDestroy(code);
        CleanByteCode(tuple->bc);
    }

    ms_ParserDestroy(prs);
    return MUNIT_OK;
}

/*
 * CLEAN UP FUNCTIONS
 */

static void CleanByteCode(ms_VMByteCode *bc) {
    for (size_t i = 0; i < bc->nvals; i++) {
        CleanValue(&bc->values[i]);
    }

    for (size_t i = 0; i < bc->nidents; i++) {
        dsbuf_destroy(bc->idents[i]);
        bc->idents[i] = NULL;
    }
}

static void CleanValue(ms_VMValue *v) {
    switch(v->type) {
        case VMVAL_STR:
            if (v->val.s) {
                dsbuf_destroy(v->val.s);
                v->val.s = NULL;
            }
            break;
        case VMVAL_FUNC:
            if (v->val.fn) {
                dsarray_destroy(v->val.fn->args);
                v->val.fn->args = NULL;
                CleanByteCode(v->val.fn->code);
                v->val.fn->code = NULL;
            }
            break;
        case VMVAL_INT:         /* fall through */
        case VMVAL_FLOAT:       /* fall through */
        case VMVAL_BOOL:        /* fall through */
        case VMVAL_NULL:
            break;
    }
}
